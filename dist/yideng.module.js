var e;!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(e||(e={}));var n=window,t=n.console,o=document,r=n.navigator,i=n.performance,a=function(){var e;return null!=(e=r.deviceMemory)?e:0},c=function(){var e;return null!=(e=r.hardwareConcurrency)?e:0},s=/*#__PURE__*/function(){function t(e){this.logUrl=void 0;var n=e.logUrl;if(!n)throw new Error("请传递要记录数据的路由~");this.logUrl=n}return t.prototype.sendToAnalytics=function(t,o,i){var a=this.logUrl;if(i&&(a=i),t==e.URGENT)if(n.fetch)fetch(a,{body:o,method:"POST",keepalive:!0});else{var c=new XMLHttpRequest;c.open("post",a,!0),c.setRequestHeader("Content-Type","application/json"),c.send(o),c.onload=function(e){c=null}}else if(t==e.IDLE)if(r.sendBeacon)navigator.sendBeacon(a,o);else{var s=new Image;s.src=a+"?body="+o,s.onload=function(){s=null}}},t}(),l={reportData:new s({logUrl:"hole"}),isResourceTiming:!1,isElementTiming:!1,maxTime:15e3},u="4g",d=!1,f=function(){return!!(c()&&c()<=4)||!!(a()&&a()<=4)},v=function(e,n){switch(e){case"slow-2g":case"2g":case"3g":return!0;default:return f()||n}},p={isHidden:!1},m=function(e){o.hidden&&(e(),p.isHidden=o.hidden)},g=function(e){return parseFloat(e.toFixed(2))},T=function(e){return"number"!=typeof e?null:g(e/Math.pow(1024,2))},h=[1e3,2500],E=[2500,4e3],y=[100,300],w=[.1,.25],k=[300,600],b={fp:h,fcp:h,lcp:E,lcpFinal:E,fid:y,fidVitals:y,cls:w,clsFinal:w,tbt:k,tbt5S:k,tbt10S:k,tbtFinal:k},S=function(e,n){return b[e]?n<=b[e][0]?"good":n<=b[e][1]?"needsImprovement":"poor":null},D=function(e,t,o){var i;i=function(){p.isHidden&&e.indexOf("Final")<0||!l.analyticsTracker||l.analyticsTracker({metricName:e,data:t,eventProperties:o||{},navigatorInformation:r?{deviceMemory:a()||0,hardwareConcurrency:c()||0,serviceWorkerStatus:"serviceWorker"in r?r.serviceWorker.controller?"controlled":"supported":"unsupported",isLowEndDevice:f(),isLowEndExperience:v(u,d)}:{},vitalsScore:S(e,t)})},"requestIdleCallback"in n?n.requestIdleCallback(i,{timeout:3e3}):i()},L=function(e,n,t){Object.keys(n).forEach(function(e){"number"==typeof n[e]&&(n[e]=g(n[e]))}),D(e,n,t)},R=function(e,n,t){var o=g(e);o<=l.maxTime&&o>=0&&D(n,o,t)},U={value:0},I={value:0},B={value:0},x={value:{beacon:0,css:0,fetch:0,img:0,other:0,script:0,total:0,xmlhttprequest:0}},q={value:0},F=function(e){var n=e.pop();n&&!n.hadRecentInput&&n.value&&(U.value+=n.value)},C={},j=function(e,n){try{var o=new PerformanceObserver(function(e){n(e.getEntries())});return o.observe({type:e,buffered:!0}),o}catch(e){t.warn("Yideng.js:",e)}return null},H=function(e){C[e]&&C[e].disconnect(),delete C[e]},M=function(e){var n=e.pop();n&&(R(n.processingStart-n.startTime,"fidVitals",{performanceEntry:n}),R(n.duration,"fid",{performanceEntry:n})),H(1),R(B.value,"lcp"),C[3]&&"function"==typeof C[3].takeRecords&&C[3].takeRecords(),R(U.value,"cls"),R(q.value,"tbt"),setTimeout(function(){R(q.value,"tbt5S")},5e3),setTimeout(function(){R(q.value,"tbt10S"),L("dataConsumption",x.value)},1e4)},O=function(e){e.forEach(function(e){if(!("self"!==e.name||e.startTime<I.value)){var n=e.duration-50;n>0&&(q.value+=n)}})},N=function(e){e.forEach(function(e){"first-paint"===e.name?R(e.startTime,"fp"):"first-contentful-paint"===e.name&&(I.value=e.startTime,R(I.value,"fcp"),C[4]=j("longtask",O),H(0))})},z=function(e){var n=e.pop();n&&(B.value=n.renderTime||n.loadTime)},P=function(e){e.forEach(function(e){e.identifier&&R(e.startTime,e.identifier)})},W=function(e){e.forEach(function(e){if(l.isResourceTiming&&L("resourceTiming",e),e.decodedBodySize&&e.initiatorType){var n=e.decodedBodySize/1e3;x.value[e.initiatorType]+=n,x.value.total+=n}})},G=function(){C[2]&&(R(B.value,"lcpFinal"),H(2)),C[3]&&("function"==typeof C[3].takeRecords&&C[3].takeRecords(),R(U.value,"clsFinal"),H(3)),C[4]&&(R(q.value,"tbtFinal"),H(4))},A=/*#__PURE__*/function(){function t(){this.errordefo=void 0,this.errordefo={}}var o=t.prototype;return o.globalError=function(){console.log("上报sdk"),console.log("[ ❌全局捕获错误 ]"),n.onerror=function(n,t,o,r,i){console.log("[ 我知道错误了 ]",n);var a=JSON.stringify({scriptURI:t,lineno:o,colno:r,error:i});return console.log(a),l.reportData.sendToAnalytics(e.IDLE,a),!0}},o.networkError=function(){n.addEventListener("error",function(e){e.target!==n&&console.log("🖼网络错误",e.target)},!0)},o.promiseError=function(){n.addEventListener("unhandledrejection",function(e){return e.preventDefault(),console.log("我知道 promise 的错误了",e.reason),!0})},o.iframeError=function(){for(var e=n.frames,t=0;t<e.length;t++)e[t].addEventListener("error",function(e){console.log("addEventListener"),console.log(e)},!0),e[t].addEventListener("unhandledrejection",function(e){console.log("unhandledrejection")},!0)},o.run=function(){this.networkError(),this.globalError(),this.promiseError()},t}(),V=function(e){console.log(e)},X=/*#__PURE__*/function(){function t(e){this.logUrl=void 0;var n=e.logUrl;if(!n)throw new Error("请传递要记录数据的路由~");this.logUrl=n}return t.prototype.sendToAnalytics=function(t,o,i){var a=this.logUrl;if(i&&(a=i),t==e.URGENT)if(n.fetch)fetch(a,{body:o,method:"POST",keepalive:!0});else{var c=new XMLHttpRequest;c.open("post",a,!0),c.setRequestHeader("Content-Type","application/json"),c.send(o),c.onload=function(e){c=null}}else if(t==e.IDLE)if(r.sendBeacon)navigator.sendBeacon(a,o);else{var s=new Image;s.src=a+"?body="+o,s.onload=function(){s=null}}},t}(),J=function(e){var n="usageDetails"in e?e.usageDetails:{};L("storageEstimate",{quota:T(e.quota),usage:T(e.usage),caches:T(n.caches),indexedDB:T(n.indexedDB),serviceWorker:T(n.serviceWorkerRegistrations)})},Y=function(e){void 0===e&&(e={}),this.v="1.0.0",this.reportData=void 0;var t=e.logUrl;if(!t)throw new Error("京程一灯系统监控平台"+this.v+"提示未传递logUrl");var a=new X({logUrl:t});l.reportData=a,this.reportData=a,l.analyticsTracker=e.analyticsTracker||V,l.isResourceTiming=!!e.resourceTiming,l.isElementTiming=!!e.elementTiming,l.maxTime=e.maxMeasureTime||l.maxTime,e.captureError&&(new A).run(),i&&i.getEntriesByType&&i.now&&i.mark&&("PerformanceObserver"in n&&(console.log("⏰ 性能收集开始",Math.random()),C[0]=j("paint",N),C[1]=j("first-input",M),C[2]=j("largest-contentful-paint",z),l.isResourceTiming&&(console.log("📚 收集页面性能数据"),j("resource",W)),C[3]=j("layout-shift",F),l.isElementTiming&&j("element",P)),void 0!==o.hidden&&o.addEventListener("visibilitychange",m.bind(this,G)),L("navigationTiming",function(){if(!(i&&i.getEntriesByType&&i.now&&i.mark))return{};var e=i.getEntriesByType("navigation")[0];if(!e)return{};var n=e.responseStart,t=e.responseEnd;return{fetchTime:t-e.fetchStart,workerTime:e.workerStart>0?t-e.workerStart:0,totalTime:t-e.requestStart,downloadTime:t-n,timeToFirstByte:n-e.requestStart,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.domainLookupEnd-e.domainLookupStart,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:e.responseStart-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}}()),L("networkInformation",function(){if("connection"in r){var e=r.connection;return"object"!=typeof e?{}:(u=e.effectiveType,d=!!e.saveData,{downlink:e.downlink,effectiveType:e.effectiveType,rtt:e.rtt,saveData:!!e.saveData})}return{}}()),r&&r.storage&&"function"==typeof r.storage.estimate&&r.storage.estimate().then(J))};export{Y as default};
//# sourceMappingURL=yideng.module.js.map
