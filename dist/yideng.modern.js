var e;!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(e||(e={}));const t=window,o=t.console,n=document,r=t.navigator,i=t.performance,a=()=>{var e;return null!=(e=r.deviceMemory)?e:0},s=()=>{var e;return null!=(e=r.hardwareConcurrency)?e:0},l={reportData:new class{constructor(e){this.logUrl=void 0;const{logUrl:t}=e;if(!t)throw new Error("请传递要记录数据的路由~");this.logUrl=t}sendToAnalytics(o,n,i){let a=this.logUrl;if(i&&(a=i),o==e.URGENT)if(t.fetch)fetch(a,{body:n,method:"POST",keepalive:!0});else{let e=new XMLHttpRequest;e.open("post",a,!0),e.setRequestHeader("Content-Type","application/json"),e.send(n),e.onload=function(t){e=null}}else if(o==e.IDLE)if(r.sendBeacon)navigator.sendBeacon(a,n);else{let e=new Image;e.src=`${a}?body=${n}`,e.onload=function(){e=null}}}}({logUrl:"hole"}),isResourceTiming:!1,isElementTiming:!1,maxTime:15e3};let c="4g",d=!1;const u=()=>!!(s()&&s()<=4)||!!(a()&&a()<=4),m=(e,t)=>{switch(e){case"slow-2g":case"2g":case"3g":return!0;default:return u()||t}},f={isHidden:!1},p=function(e){n.hidden&&(e(),f.isHidden=n.hidden)},v=e=>parseFloat(e.toFixed(2)),g=e=>"number"!=typeof e?null:v(e/Math.pow(1024,2)),T=[1e3,2500],h=[2500,4e3],E=[100,300],y=[.1,.25],w=[300,600],k={fp:T,fcp:T,lcp:h,lcpFinal:h,fid:E,fidVitals:E,cls:y,clsFinal:y,tbt:w,tbt5S:w,tbt10S:w,tbtFinal:w},b=(e,t)=>k[e]?t<=k[e][0]?"good":t<=k[e][1]?"needsImprovement":"poor":null,S=function(e,o,n){var i;i=()=>{f.isHidden&&e.indexOf("Final")<0||!l.analyticsTracker||l.analyticsTracker({metricName:e,data:o,eventProperties:n||{},navigatorInformation:r?{deviceMemory:a()||0,hardwareConcurrency:s()||0,serviceWorkerStatus:"serviceWorker"in r?r.serviceWorker.controller?"controlled":"supported":"unsupported",isLowEndDevice:u(),isLowEndExperience:m(c,d)}:{},vitalsScore:b(e,o)})},"requestIdleCallback"in t?t.requestIdleCallback(i,{timeout:3e3}):i()},D=(e,t,o)=>{Object.keys(t).forEach(e=>{"number"==typeof t[e]&&(t[e]=v(t[e]))}),S(e,t,o)},L=(e,t,o)=>{const n=v(e);n<=l.maxTime&&n>=0&&S(t,n,o)},R={value:0},U={value:0},I={value:0},B={value:{beacon:0,css:0,fetch:0,img:0,other:0,script:0,total:0,xmlhttprequest:0}},x={value:0},q=e=>{const t=e.pop();t&&!t.hadRecentInput&&t.value&&(R.value+=t.value)},F={},C=(e,t)=>{try{const o=new PerformanceObserver(e=>{t(e.getEntries())});return o.observe({type:e,buffered:!0}),o}catch(e){o.warn("Yideng.js:",e)}return null},j=e=>{F[e]&&F[e].disconnect(),delete F[e]},H=e=>{const t=e.pop();t&&(L(t.processingStart-t.startTime,"fidVitals",{performanceEntry:t}),L(t.duration,"fid",{performanceEntry:t})),j(1),L(I.value,"lcp"),F[3]&&"function"==typeof F[3].takeRecords&&F[3].takeRecords(),L(R.value,"cls"),L(x.value,"tbt"),setTimeout(()=>{L(x.value,"tbt5S")},5e3),setTimeout(()=>{L(x.value,"tbt10S"),D("dataConsumption",B.value)},1e4)},M=e=>{e.forEach(e=>{if("self"!==e.name||e.startTime<U.value)return;const t=e.duration-50;t>0&&(x.value+=t)})},O=e=>{e.forEach(e=>{"first-paint"===e.name?L(e.startTime,"fp"):"first-contentful-paint"===e.name&&(U.value=e.startTime,L(U.value,"fcp"),F[4]=C("longtask",M),j(0))})},N=e=>{const t=e.pop();t&&(I.value=t.renderTime||t.loadTime)},z=e=>{e.forEach(e=>{e.identifier&&L(e.startTime,e.identifier)})},P=e=>{e.forEach(e=>{if(l.isResourceTiming&&D("resourceTiming",e),e.decodedBodySize&&e.initiatorType){const t=e.decodedBodySize/1e3;B.value[e.initiatorType]+=t,B.value.total+=t}})},W=()=>{F[2]&&(L(I.value,"lcpFinal"),j(2)),F[3]&&("function"==typeof F[3].takeRecords&&F[3].takeRecords(),L(R.value,"clsFinal"),j(3)),F[4]&&(L(x.value,"tbtFinal"),j(4))};class ${constructor(){this.errordefo=void 0,this.errordefo={}}globalError(){console.log("上报sdk"),console.log("[ ❌全局捕获错误 ]"),t.onerror=(t,o,n,r,i)=>{console.log("[ 我知道错误了 ]",t);const a=JSON.stringify({scriptURI:o,lineno:n,colno:r,error:i});return console.log(a),l.reportData.sendToAnalytics(e.IDLE,a),!0}}networkError(){t.addEventListener("error",function(e){e.target!==t&&console.log("🖼网络错误",e.target)},!0)}promiseError(){t.addEventListener("unhandledrejection",function(e){return e.preventDefault(),console.log("我知道 promise 的错误了",e.reason),!0})}iframeError(){const e=t.frames;for(let t=0;t<e.length;t++)e[t].addEventListener("error",e=>{console.log("addEventListener"),console.log(e)},!0),e[t].addEventListener("unhandledrejection",function(e){console.log("unhandledrejection")},!0)}run(){this.networkError(),this.globalError(),this.promiseError()}}const G=e=>{console.log(e)};class A{constructor(e){this.logUrl=void 0;const{logUrl:t}=e;if(!t)throw new Error("请传递要记录数据的路由~");this.logUrl=t}sendToAnalytics(o,n,i){let a=this.logUrl;if(i&&(a=i),o==e.URGENT)if(t.fetch)fetch(a,{body:n,method:"POST",keepalive:!0});else{let e=new XMLHttpRequest;e.open("post",a,!0),e.setRequestHeader("Content-Type","application/json"),e.send(n),e.onload=function(t){e=null}}else if(o==e.IDLE)if(r.sendBeacon)navigator.sendBeacon(a,n);else{let e=new Image;e.src=`${a}?body=${n}`,e.onload=function(){e=null}}}}const V=e=>{const t="usageDetails"in e?e.usageDetails:{};D("storageEstimate",{quota:g(e.quota),usage:g(e.usage),caches:g(t.caches),indexedDB:g(t.indexedDB),serviceWorker:g(t.serviceWorkerRegistrations)})};class X{constructor(e={}){this.v="1.0.0",this.reportData=void 0;const o=e.logUrl;if(!o)throw new Error(`京程一灯系统监控平台${this.v}提示未传递logUrl`);const a=new A({logUrl:o});l.reportData=a,this.reportData=a,l.analyticsTracker=e.analyticsTracker||G,l.isResourceTiming=!!e.resourceTiming,l.isElementTiming=!!e.elementTiming,l.maxTime=e.maxMeasureTime||l.maxTime,e.captureError&&(new $).run(),i&&i.getEntriesByType&&i.now&&i.mark&&("PerformanceObserver"in t&&(console.log("⏰ 性能收集开始",Math.random()),F[0]=C("paint",O),F[1]=C("first-input",H),F[2]=C("largest-contentful-paint",N),l.isResourceTiming&&(console.log("📚 收集页面性能数据"),C("resource",P)),F[3]=C("layout-shift",q),l.isElementTiming&&C("element",z)),void 0!==n.hidden&&n.addEventListener("visibilitychange",p.bind(this,W)),D("navigationTiming",(()=>{if(!(i&&i.getEntriesByType&&i.now&&i.mark))return{};const e=i.getEntriesByType("navigation")[0];if(!e)return{};const t=e.responseStart,o=e.responseEnd;return{fetchTime:o-e.fetchStart,workerTime:e.workerStart>0?o-e.workerStart:0,totalTime:o-e.requestStart,downloadTime:o-t,timeToFirstByte:t-e.requestStart,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.domainLookupEnd-e.domainLookupStart,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:e.responseStart-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}})()),D("networkInformation",(()=>{if("connection"in r){const e=r.connection;return"object"!=typeof e?{}:(c=e.effectiveType,d=!!e.saveData,{downlink:e.downlink,effectiveType:e.effectiveType,rtt:e.rtt,saveData:!!e.saveData})}return{}})()),r&&r.storage&&"function"==typeof r.storage.estimate&&r.storage.estimate().then(V))}}export{X as default};
//# sourceMappingURL=yideng.modern.js.map
